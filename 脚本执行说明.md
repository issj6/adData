## 脚本执行说明

适用范围：Docker 容器内（服务名：`ad-data-app`，容器内工作目录：`/app`）。

### 环境约定
- 已内置 `python3` 与 `cron`，时区为 `Asia/Shanghai`。
- 两个脚本已在开头设置 `PATH`，cron 下可正常找到命令。
- 日志与归档目录通过卷挂载到宿主机：
  - `/app/logs` → 宿主机 `./logs`
  - `/app/data_archive/archives` → 宿主机 `/data/ad/archives`
  - `/app/data_archive/logs` → 宿主机 `/data/ad/logs`

---

### 一、容器内手动执行

无需进入交互 shell，可直接从宿主机执行：

```bash
# 手动执行 ETL（默认处理昨天，包含最近7天回滚）
docker compose exec ad-data-app /app/run_daily_etl.sh

# 查看 ETL 日志
docker compose exec ad-data-app bash -lc 'tail -n +1 /app/logs/daily_etl_$(date +%Y%m%d).log'

# 手动执行归档（导出30天前数据为 CSV 并删除）
docker compose exec ad-data-app /app/data_archive/archive_old_data.sh

# 查看归档日志
docker compose exec ad-data-app bash -lc 'tail -n +1 /app/data_archive/logs/archive_$(date +%Y%m%d).log'
```

如需进入容器后执行：

```bash
docker compose exec -it ad-data-app bash
# 容器内：
/app/run_daily_etl.sh
/app/data_archive/archive_old_data.sh
```

---

### 二、定时任务执行说明

容器构建时已写入 crontab：

```cron
0 1 * * * /app/data_archive/archive_old_data.sh   # 每日 01:00 归档
0 3 * * * /app/run_daily_etl.sh                   # 每日 03:00 ETL
```

常用验证命令：

```bash
# 查看容器内 crontab 条目
docker compose exec ad-data-app bash -lc 'crontab -l | cat'

# 确认 cron 服务已启动（容器入口脚本会启动）
docker compose exec ad-data-app bash -lc 'ps aux | grep -v grep | grep cron || service cron status || true'

# 观察最近一次定时执行的日志（按日期轮转）
docker compose exec ad-data-app bash -lc 'ls -l /app/logs && tail -n 200 /app/logs/daily_etl_$(date +%Y%m%d).log || true'
docker compose exec ad-data-app bash -lc 'ls -l /app/data_archive/logs && tail -n 200 /app/data_archive/logs/archive_$(date +%Y%m%d).log || true'
```

如需在非调度时间窗口验证功能，请手动执行脚本（见“手动执行”小节）。

---

### 三、日志与退出码

- ETL 日志：`/app/logs/daily_etl_YYYYMMDD.log`（保留 30 天）
- 归档日志：`/app/data_archive/logs/archive_YYYYMMDD.log`
- 归档日报：`/app/data_archive/logs/archive_report_YYYYMMDD.txt`
- 退出码：脚本成功返回 `0`，失败返回非 `0`。

---

### 四、常见问题

- Python 未找到：已在脚本内设置 `PATH`，cron 环境下可找到 `python3`。
- cron 未运行：容器入口脚本已启动 cron，如未运行可手动执行 `service cron start`（容器内）。
- 权限问题：确保宿主机目录 `/data/ad/archives`、`/data/ad/logs` 存在且可写。

---

### 五、宿主机快捷命令合集

```bash
# 查看服务日志（Web/启动日志）
docker compose logs -f

# 手动执行两个脚本
docker compose exec ad-data-app /app/run_daily_etl.sh
docker compose exec ad-data-app /app/data_archive/archive_old_data.sh

# 查看定时任务与日志
docker compose exec ad-data-app bash -lc 'crontab -l | cat'
docker compose exec ad-data-app bash -lc 'tail -n 200 /app/logs/daily_etl_$(date +%Y%m%d).log || true'
docker compose exec ad-data-app bash -lc 'tail -n 200 /app/data_archive/logs/archive_$(date +%Y%m%d).log || true'
```


